name: Ultimate Bot Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # max 6 jam

    environment: production

    steps:
      # 1ï¸âƒ£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      # 2ï¸âƒ£ Setup Python
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      # 3ï¸âƒ£ Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4ï¸âƒ£ Set environment variables untuk bot
      - name: Set bot tokens and IDs
        run: |
          echo "TOKEN_NASABAH=${{ secrets.TOKEN_NASABAH }}" >> $GITHUB_ENV
          echo "TOKEN_ABSENSI=${{ secrets.TOKEN_ABSENSI }}" >> $GITHUB_ENV
          echo "DATA_GROUP_ID=${{ secrets.DATA_GROUP_ID }}" >> $GITHUB_ENV
          echo "ABSEN_GROUP_ID=${{ secrets.ABSEN_GROUP_ID }}" >> $GITHUB_ENV
          echo "ADMIN_IDS=${{ secrets.ADMIN_IDS }}" >> $GITHUB_ENV

      # 5ï¸âƒ£ Jalankan bot dengan auto-restart
      - name: Run Ultimate Bot (auto-restart)
        run: |
          echo "ğŸš€ Starting Ultimate Bot with auto-restart..."
          while true; do
            python ultimate.py
            echo "âš ï¸ Bot crashed or stopped. Restarting in 5s..."
            sleep 5
          done
